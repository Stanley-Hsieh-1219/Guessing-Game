<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ çŒœè¬å¤§æŒ‘æˆ°</title>
    <meta name="description" content="çŒœè¬å¤§æŒ‘æˆ° â€” äº”å¤§é¡åˆ¥ã€ä¸‰ç¨®é›£åº¦ï¼ŒæŒ‘æˆ°ä½ çš„çŸ¥è­˜æ¥µé™ï¼">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans TC', sans-serif
        }

        body {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 50%, #fed7aa 100%);
            min-height: 100vh
        }

        .card-float {
            animation: floatUp .5s cubic-bezier(.22, 1, .36, 1) forwards;
            opacity: 0;
            transform: translateY(30px)
        }

        @keyframes floatUp {
            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .sel-btn {
            transition: all .3s cubic-bezier(.22, 1, .36, 1)
        }

        .sel-btn:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 16px 32px -8px rgba(0, 0, 0, .2)
        }

        .sel-btn:active {
            transform: translateY(-1px) scale(.98)
        }

        .feedback-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            pointer-events: none;
            animation: fbPop .3s cubic-bezier(.22, 1, .36, 1) forwards
        }

        @keyframes fbPop {
            0% {
                opacity: 0;
                transform: scale(.3)
            }

            60% {
                opacity: 1;
                transform: scale(1.15)
            }

            100% {
                opacity: 1;
                transform: scale(1)
            }
        }

        .feedback-overlay.fade-out {
            animation: fbFade .4s ease forwards
        }

        @keyframes fbFade {
            to {
                opacity: 0;
                transform: scale(.8)
            }
        }

        .progress-fill {
            transition: width .5s cubic-bezier(.22, 1, .36, 1)
        }

        .answer-input:focus {
            box-shadow: 0 0 0 4px rgba(251, 146, 60, .3)
        }

        .score-bounce {
            animation: sBounce .4s ease
        }

        @keyframes sBounce {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.3)
            }
        }

        .star-spin {
            animation: starSpin 1s ease forwards
        }

        @keyframes starSpin {
            0% {
                opacity: 0;
                transform: rotate(-180deg) scale(0)
            }

            100% {
                opacity: 1;
                transform: rotate(0) scale(1)
            }
        }

        .hint-card {
            animation: hSlide .4s cubic-bezier(.22, 1, .36, 1) forwards;
            opacity: 0
        }

        .hint-card:nth-child(1) {
            animation-delay: .1s
        }

        .hint-card:nth-child(2) {
            animation-delay: .25s
        }

        .hint-card:nth-child(3) {
            animation-delay: .4s
        }

        @keyframes hSlide {
            from {
                opacity: 0;
                transform: translateX(-20px)
            }

            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        #app>div {
            background: #fff;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, .12)
        }
    </style>
</head>

<body class="flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-lg mx-auto"></div>
    <script src="data-food.js"></script>
    <script src="data-transport.js"></script>
    <script src="data-land.js"></script>
    <script src="data-sea.js"></script>
    <script src="data-city.js"></script>
    <script>
        // ===== é¡åˆ¥èˆ‡é›£åº¦è¨­å®š =====
        const categories = {
            food: { label: 'ğŸ½ï¸ ç¾é£Ÿ', color: 'from-orange-400 to-amber-600' },
            transport: { label: 'ğŸš— äº¤é€šå·¥å…·', color: 'from-blue-400 to-indigo-600' },
            land: { label: 'ğŸ¦ é™¸åœ°å‹•ç‰©', color: 'from-green-400 to-emerald-600' },
            sea: { label: 'ğŸ³ æµ·æ´‹å‹•ç‰©', color: 'from-cyan-400 to-teal-600' },
            city: { label: 'ğŸ™ï¸ ä¸–ç•ŒçŸ¥ååŸå¸‚', color: 'from-purple-400 to-violet-600' },
        };
        const difficulties = {
            easy: { label: 'ğŸ¥„ æ–°æ‰‹', color: 'from-green-400 to-emerald-600', desc: 'åŸºç¤é¡Œç›®ï¼Œæç¤ºç›´æ¥å‹å–„' },
            normal: { label: 'ğŸ³ è³‡æ·±', color: 'from-orange-400 to-amber-600', desc: 'éœ€è¦æ›´å¤šçŸ¥è­˜æ‰èƒ½çŒœä¸­' },
            hard: { label: 'â­ å¤§å¸«', color: 'from-red-400 to-rose-600', desc: 'è©©æ„æç¤ºï¼Œè€ƒé©—ä½ çš„ç´ é¤Š' },
        };

        // ===== é¡Œåº« (5é¡åˆ¥ Ã— 3é›£åº¦ Ã— 50é¡Œ) =====
        const questions = {
            food: foodQuestions,
            transport: transportQuestions,
            land: landQuestions,
            sea: seaQuestions,
            city: cityQuestions
        };

        // ===== é¡å¤–æç¤ºå°ç…§è¡¨ =====
        const bonusHints = Object.assign({}, foodBonusHints, transportBonusHints, landBonusHints, seaBonusHints, cityBonusHints);

        // ===== æ’è¡Œæ¦œ API =====
        const LEADERBOARD_API = 'https://script.google.com/macros/s/AKfycbzBP8R0paYZg6Sa5RX2aG5d3QqVPfeJP9m559QSGTFog8oz8l3fR959R6Z4oL1UkWg/exec';

        // ===== éŠæˆ²ç‹€æ…‹ =====
        const state = { screen: 'start', category: null, level: null, currentQuestions: [], questionIndex: 0, attempt: 1, score: 0, inputLocked: false, results: [], usedExtraHint: false, usedFirstChar: false, extraHintText: '', firstCharText: '', leaderboard: [], leaderboardLoading: false, leaderboardFetched: false, scoreSubmitted: false, isSubmitting: false, viewLeaderboardData: [], viewLeaderboardLoading: false, viewLeaderboardDiff: 'easy' };

        function shuffle(a) { const b = [...a]; for (let i = b.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[b[i], b[j]] = [b[j], b[i]]; } return b; }

        function render() {
            const app = document.getElementById('app');
            switch (state.screen) {
                case 'start': app.innerHTML = renderStart(); break;
                case 'category': app.innerHTML = renderCategory(); break;
                case 'difficulty': app.innerHTML = renderDifficulty(); break;
                case 'leaderboard_view': app.innerHTML = renderLeaderboardView(); break;
                case 'play': app.innerHTML = renderPlay(); break;
                case 'result': app.innerHTML = renderResult(); break;
            }
            bindEvents();
        }

        function renderStart() {
            return `<div class="card-float text-center py-10">
        <div class="text-7xl mb-4">ğŸ¯</div>
        <h1 class="text-3xl sm:text-4xl font-black text-orange-800 mb-2">çŒœè¬å¤§æŒ‘æˆ°</h1>
        <p class="text-orange-600 mb-8 text-sm">äº”å¤§é¡åˆ¥ã€ä¸‰ç¨®é›£åº¦ï¼ŒæŒ‘æˆ°ä½ çš„çŸ¥è­˜æ¥µé™ï¼</p>
        <button id="start-btn" class="sel-btn bg-gradient-to-br from-orange-400 to-amber-600 text-white font-black text-lg rounded-2xl px-10 py-4 shadow-lg cursor-pointer">
            ğŸš€ é–‹å§‹éŠæˆ²
        </button>
        <p class="text-orange-400 text-xs mt-6">æ¯å›åˆ 10 é¡Œ â€§ æ¯é¡Œ 2 æ¬¡æ©Ÿæœƒ â€§ æ»¿åˆ† 100 åˆ†</p>
    </div>`;
        }

        function renderCategory() {
            const cats = Object.entries(categories);
            return `<div class="card-float text-center py-6">
        <h2 class="text-2xl font-black text-orange-800 mb-1">ğŸ¯ çŒœè¬å¤§æŒ‘æˆ°</h2>
        <p class="text-orange-500 text-sm mb-6">â€” é¸æ“‡æŒ‘æˆ°é¡åˆ¥ â€”</p>
        <div class="space-y-3 px-2 sm:px-6">
            ${cats.map(([k, v]) => `
            <button data-cat="${k}" class="sel-btn w-full bg-gradient-to-br ${v.color} text-white rounded-2xl p-4 text-left shadow-lg cursor-pointer">
                <span class="font-black text-lg">${v.label}</span>
            </button>`).join('')}
        </div>
    </div>`;
        }

        function renderDifficulty() {
            const cat = categories[state.category];
            const diffs = Object.entries(difficulties);
            return `<div class="card-float text-center py-6">
        <h2 class="text-2xl font-black text-orange-800 mb-1">${cat.label}</h2>
        <p class="text-orange-500 text-sm mb-6">â€” é¸æ“‡é›£åº¦ç­‰ç´š â€”</p>
        <div class="space-y-3 px-2 sm:px-6">
            ${diffs.map(([k, v]) => `
            <button data-diff="${k}" class="sel-btn w-full bg-gradient-to-br ${v.color} text-white rounded-2xl p-4 text-left shadow-lg cursor-pointer">
                <div class="font-black text-lg">${v.label}</div>
                <div class="text-white/80 text-xs">${v.desc}</div>
            </button>`).join('')}
            
            <button id="btn-view-leaderboard" class="sel-btn w-full bg-white border-2 border-orange-300 text-orange-600 rounded-2xl p-4 text-center shadow-lg cursor-pointer flex items-center justify-center gap-2 mt-4">
                <span class="text-xl">ğŸ†</span>
                <span class="font-black text-lg">æŸ¥é–±æ’è¡Œæ¦œ</span>
            </button>
        </div>
        <button id="back-cat" class="mt-4 text-orange-400 text-sm underline cursor-pointer hover:text-orange-600">â† è¿”å›é¸æ“‡é¡åˆ¥</button>
    </div>`;
        }

        function renderLeaderboardView() {
            const cat = categories[state.category];
            const diffs = Object.entries(difficulties);
            return `<div class="card-float text-center py-6">
        <h2 class="text-2xl font-black text-orange-800 mb-1">${cat.label} æ’è¡Œæ¦œ</h2>
        
        <div class="flex justify-center gap-2 mt-4 mb-4 px-4">
            ${diffs.map(([k, v]) => `
            <button data-lb-diff="${k}" class="flex-1 py-2 rounded-xl text-sm font-bold transition-all ${state.viewLeaderboardDiff === k ? 'bg-gradient-to-br ' + v.color.split(' ')[0] + ' ' + v.color.split(' ')[1] + ' text-white shadow-md' : 'bg-orange-50 text-orange-600 border border-orange-200 cursor-pointer hover:bg-orange-100'}">
                ${v.label}
            </button>`).join('')}
        </div>

        <div class="text-left px-4 mb-6 min-h-[250px] max-h-[350px] overflow-y-auto">
            ${state.viewLeaderboardLoading ? `<div class="text-center py-8 text-orange-400"><span class="inline-block animate-spin mr-2 text-2xl">â³</span><br>è¼‰å…¥ä¸­...</div>` :
                    state.viewLeaderboardData.length === 0 ? `<div class="text-center py-8 text-orange-300">å°šç„¡ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€ä½æŒ‘æˆ°è€…å§ï¼</div>` : `
            <div class="space-y-2">
                ${state.viewLeaderboardData.map(entry => {
                        let icon, rowClass;
                        if (entry.rank === 1) { icon = '<span class="text-xl" style="filter:drop-shadow(0 1px 2px rgba(234,179,8,.5))">ğŸ†</span>'; rowClass = 'bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200'; }
                        else if (entry.rank === 2) { icon = '<span class="text-xl" style="filter:drop-shadow(0 1px 2px rgba(156,163,175,.5))">ğŸ¥ˆ</span>'; rowClass = 'bg-gradient-to-r from-gray-50 to-slate-50 border border-gray-200'; }
                        else if (entry.rank === 3) { icon = '<span class="text-xl" style="filter:drop-shadow(0 1px 2px rgba(180,83,9,.4))">ğŸ¥‰</span>'; rowClass = 'bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200'; }
                        else { icon = '<span class="text-base font-black text-orange-400 w-7 inline-block text-center">' + entry.rank + '</span>'; rowClass = 'bg-orange-50'; }
                        return `<div class="flex items-center gap-3 text-base ${rowClass} rounded-xl px-4 py-3 shadow-sm">
                        <span class="w-8 text-center">${icon}</span>
                        <span class="flex-1 text-orange-800 font-bold truncate">${entry.name}</span>
                        <span class="font-black text-orange-600">${entry.score} åˆ†</span>
                    </div>`;
                    }).join('')}
            </div>`}
        </div >

                        <button id="back-diff" class="text-orange-500 font-bold underline cursor-pointer hover:text-orange-700">â† è¿”å›é¸æ“‡é›£åº¦ç­‰ç´š</button>
    </div > `;
        }

        function renderPlay() {
            const q = state.currentQuestions[state.questionIndex];
            const cat = categories[state.category];
            const diff = difficulties[state.level];
            const progress = (state.questionIndex / state.currentQuestions.length) * 100;
            return `< div class= "card-float" >
        <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
            <span class="text-xs font-bold px-3 py-1 rounded-full bg-gradient-to-br ${cat.color} text-white shadow">${cat.label}</span>
            <span class="text-xs font-bold px-3 py-1 rounded-full bg-gradient-to-br ${diff.color} text-white shadow">${diff.label}</span>
            <span id="score-display" class="text-orange-700 font-black text-lg">${state.score} åˆ†</span>
        </div>
        <div class="w-full h-2 bg-orange-100 rounded-full mb-5 overflow-hidden">
            <div class="progress-fill h-full rounded-full bg-gradient-to-r ${cat.color}" style="width:${progress}%"></div>
        </div>
        <div class="text-center mb-4">
            <span class="text-orange-400 text-sm font-bold">ç¬¬ ${state.questionIndex + 1} / ${state.currentQuestions.length} é¡Œ</span>
            <span class="text-orange-300 text-xs ml-2">ï¼ˆç¬¬ ${state.attempt} æ¬¡å˜—è©¦ï¼‰</span>
        </div>
        <div class="space-y-3 mb-4 px-1">
            ${q.hints.map((h, i) => {
                const icons = ['ğŸ’¬', 'ğŸ ', 'ğŸ“'], labels = ['æç¤ºä¸€', 'æç¤ºäºŒ', 'æç¤ºä¸‰'];
                return `<div class="hint-card flex items-start gap-3 bg-orange-50 rounded-xl p-3 border border-orange-100">
                    <span class="text-xl mt-0.5">${icons[i]}</span>
                    <div><div class="text-[10px] text-orange-400 font-bold tracking-widest">${labels[i]}</div>
                    <div class="text-orange-800 text-sm font-medium">${h}</div></div>
                </div>`;
            }).join('')}
            ${state.extraHintText ? `<div class="hint-card flex items-start gap-3 bg-amber-50 rounded-xl p-3 border border-amber-200">
                <span class="text-xl mt-0.5">ğŸ”</span>
                <div><div class="text-[10px] text-amber-500 font-bold tracking-widest">é¡å¤–æç¤º</div>
                <div class="text-amber-700 text-sm font-medium">${state.extraHintText}</div></div>
            </div>` : ''}
            ${state.firstCharText ? `<div class="hint-card flex items-start gap-3 bg-emerald-50 rounded-xl p-3 border border-emerald-200">
                <span class="text-xl mt-0.5">ğŸ”¤</span>
                <div><div class="text-[10px] text-emerald-500 font-bold tracking-widest">é¦–å­—æç¤º</div>
                <div class="text-emerald-700 text-sm font-medium">${state.firstCharText}</div></div>
            </div>` : ''}
        </div>
        <div class="flex gap-2 px-1 mb-3">
            <button id="btn-extra-hint" class="flex-1 text-xs py-2 px-2 rounded-lg border-2 font-bold transition-all ${state.usedExtraHint ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-amber-50 text-amber-600 border-amber-300 hover:bg-amber-100 cursor-pointer'}" ${state.usedExtraHint || state.inputLocked ? 'disabled' : ''}>ğŸ’¡ å†ä¸€å€‹æç¤º</button>
            <button id="btn-first-char" class="flex-1 text-xs py-2 px-2 rounded-lg border-2 font-bold transition-all ${state.usedFirstChar ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-emerald-50 text-emerald-600 border-emerald-300 hover:bg-emerald-100 cursor-pointer'}" ${state.usedFirstChar || state.inputLocked ? 'disabled' : ''}>ğŸ”¤ çµ¦æˆ‘ç¬¬ä¸€å€‹å­—</button>
            <button id="btn-give-up" class="flex-1 text-xs py-2 px-2 rounded-lg border-2 font-bold transition-all ${state.inputLocked ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-red-50 text-red-500 border-red-300 hover:bg-red-100 cursor-pointer'}" ${state.inputLocked ? 'disabled' : ''}>ğŸ³ï¸ æ”¾æ£„</button>
        </div>
        <div class="flex gap-2 px-1">
            <input id="answer-input" type="text" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆâ€¦"
                class="answer-input flex-1 border-2 border-orange-200 rounded-xl px-4 py-3 text-base outline-none focus:border-orange-400 transition-all ${state.inputLocked ? 'opacity-50 cursor-not-allowed' : ''}"
                ${state.inputLocked ? 'disabled' : ''} autocomplete="off">
            <button id="submit-btn" class="px-5 py-3 bg-gradient-to-br ${cat.color} text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95 ${state.inputLocked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}"
                ${state.inputLocked ? 'disabled' : ''}>é€å‡º</button>
        </div>
    </div > `;
        }

        function renderResult() {
            const cat = categories[state.category];
            const total = state.currentQuestions.length * 10;
            const pct = Math.round((state.score / total) * 100);
            let rE, rT;
            if (pct >= 90) { rE = 'ğŸ‘¨â€ğŸ³'; rT = 'å¤©æ‰é™è‡¨ï¼å®Œç¾è¡¨ç¾ï¼'; }
            else if (pct >= 70) { rE = 'ğŸ‰'; rT = 'å¤ªå²å®³äº†ï¼ä½ æ˜¯çŸ¥è­˜é”äººï¼'; }
            else if (pct >= 50) { rE = 'ğŸ˜‹'; rT = 'ä¸éŒ¯å–”ï¼ç¹¼çºŒåŠ æ²¹ï¼'; }
            else if (pct >= 30) { rE = 'ğŸ¤”'; rT = 'å†å¤šå­¸ä¸€äº›å°±çŸ¥é“äº†ï¼'; }
            else { rE = 'ğŸ˜…'; rT = 'æ²’é—œä¿‚ï¼Œå­¸ç¿’çš„è·¯é‚„å¾ˆé•·ï¼'; }
            return `< div class= "card-float text-center py-6" >
        <div class="star-spin text-7xl mb-3">${rE}</div>
        <h2 class="text-2xl font-black text-orange-800 mb-1">éŠæˆ²çµæŸï¼</h2>
        <p class="text-orange-600 text-sm mb-4">${cat.label} â€§ ${difficulties[state.level].label}</p>
        <div class="bg-gradient-to-br ${cat.color} text-white rounded-2xl p-6 mx-4 mb-4 shadow-lg">
            <div class="text-5xl font-black mb-1">${state.score}</div>
            <div class="text-white/80 text-sm">æ»¿åˆ† ${total} åˆ†</div>
        </div>
        <p class="text-orange-700 font-bold text-lg mb-4">${rT}</p>
        <!-- å§“åè¼¸å…¥å€ -->
        <div class="px-4 mb-5">
            ${state.scoreSubmitted ? `<div class="bg-green-50 border border-green-200 rounded-xl p-3 text-green-600 text-sm font-bold">âœ… ç´€éŒ„å·²æˆåŠŸé€å‡ºï¼</div>` : `
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                <p class="text-amber-700 text-sm font-bold mb-3">ğŸ“ è¼¸å…¥å§“åï¼Œè¨˜éŒ„ä½ çš„æˆç¸¾ï¼</p>
                <div class="flex gap-2">
                    <input id="name-input" type="text" maxlength="20" placeholder="è«‹è¼¸å…¥å§“åï¼ˆä¸Šé™20å­—ï¼‰"
                        class="flex-1 border-2 border-amber-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-amber-400 transition-all" autocomplete="off">
                    <button id="submit-score-btn" class="px-5 py-2.5 bg-gradient-to-br from-amber-400 to-orange-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95 cursor-pointer text-sm">é€å‡º</button>
                </div>
            </div>`}
        </div>
        <!--æ’è¡Œæ¦œ -->
        <div class="text-left px-4 mb-5">
            <p class="text-xs text-orange-400 font-bold mb-2">â€” ğŸ† æ’è¡Œæ¦œ TOP 10 â€”</p>
            ${state.leaderboardLoading ? `<div class="text-center py-4 text-orange-400 text-sm"><span class="inline-block animate-spin mr-1">â³</span> è¼‰å…¥ä¸­...</div>` :
                    state.leaderboard.length === 0 ? `<div class="text-center py-4 text-orange-300 text-sm">å°šç„¡ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€ä½æŒ‘æˆ°è€…å§ï¼</div>` : `
            <div class="space-y-1.5">
                ${state.leaderboard.map(entry => {
                        let icon, rowClass;
                        if (entry.rank === 1) { icon = '<span class="text-lg" style="filter:drop-shadow(0 1px 2px rgba(234,179,8,.5))">ğŸ†</span>'; rowClass = 'bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200'; }
                        else if (entry.rank === 2) { icon = '<span class="text-lg" style="filter:drop-shadow(0 1px 2px rgba(156,163,175,.5))">ğŸ¥ˆ</span>'; rowClass = 'bg-gradient-to-r from-gray-50 to-slate-50 border border-gray-200'; }
                        else if (entry.rank === 3) { icon = '<span class="text-lg" style="filter:drop-shadow(0 1px 2px rgba(180,83,9,.4))">ğŸ¥‰</span>'; rowClass = 'bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200'; }
                        else { icon = '<span class="text-sm font-black text-orange-400 w-6 inline-block text-center">' + entry.rank + '</span>'; rowClass = 'bg-orange-50'; }
                        return `<div class="flex items-center gap-2 text-sm ${rowClass} rounded-lg px-3 py-2">
                        <span class="w-8 text-center">${icon}</span>
                        <span class="flex-1 text-orange-800 font-medium truncate">${entry.name}</span>
                        <span class="font-black text-orange-600">${entry.score} åˆ†</span>
                    </div>`;
                    }).join('')}
            </div>`}
        </div>
        <!--ç­”é¡Œç´€éŒ„ -->
        <div class="text-left px-4 mb-5">
            <p class="text-xs text-orange-400 font-bold mb-2">â€” ğŸ“‹ ç­”é¡Œç´€éŒ„ â€”</p>
            <div class="space-y-1.5 max-h-48 overflow-y-auto pr-1">
                ${state.results.map((r, i) => `
                <div class="flex items-center gap-2 text-sm bg-orange-50 rounded-lg px-3 py-2">
                    <span class="font-bold text-orange-400 w-5">${i + 1}.</span>
                    <span class="flex-1 text-orange-800 font-medium">${r.word}</span>
                    ${r.correct ? `<span class="text-green-500 font-black">â­• +${r.points}</span>` : `<span class="text-red-400 font-black">âŒ 0</span>`}
                </div>`).join('')}
            </div>
        </div>
        <div class="space-y-3 px-6">
            <button id="retry-btn" class="w-full bg-gradient-to-br ${cat.color} text-white font-bold rounded-xl py-3 shadow-md hover:shadow-lg transition-all active:scale-95 cursor-pointer">ğŸ”„ å†æŒ‘æˆ°ä¸€æ¬¡</button>
            <button id="menu-btn" class="w-full bg-white border-2 border-orange-300 text-orange-600 font-bold rounded-xl py-3 hover:bg-orange-50 transition-all active:scale-95 cursor-pointer">ğŸ  å›åˆ°ä¸»é¸å–®</button>
        </div>
    </div > `;
        }

        function bindEvents() {
            document.getElementById('start-btn')?.addEventListener('click', () => { state.screen = 'category'; render(); });
            document.querySelectorAll('[data-cat]').forEach(b => b.addEventListener('click', () => { state.category = b.dataset.cat; state.screen = 'difficulty'; render(); }));
            document.querySelectorAll('[data-diff]').forEach(b => b.addEventListener('click', () => { startGame(b.dataset.diff); }));
            document.getElementById('back-cat')?.addEventListener('click', () => { state.screen = 'category'; render(); });

            document.getElementById('btn-view-leaderboard')?.addEventListener('click', () => { state.screen = 'leaderboard_view'; state.viewLeaderboardData = []; render(); fetchLeaderboardView(); });
            document.querySelectorAll('[data-lb-diff]').forEach(b => b.addEventListener('click', () => { if (state.viewLeaderboardDiff !== b.dataset.lbDiff) { state.viewLeaderboardDiff = b.dataset.lbDiff; state.viewLeaderboardData = []; render(); fetchLeaderboardView(); } }));
            document.getElementById('back-diff')?.addEventListener('click', () => { state.screen = 'difficulty'; render(); });
            document.getElementById('submit-btn')?.addEventListener('click', submitAnswer);
            const inp = document.getElementById('answer-input');
            if (inp) { inp.addEventListener('keydown', e => { if (e.key === 'Enter' && !state.inputLocked) submitAnswer(); }); if (!state.inputLocked) setTimeout(() => inp.focus(), 100); }
            document.getElementById('btn-extra-hint')?.addEventListener('click', useExtraHint);
            document.getElementById('btn-first-char')?.addEventListener('click', useFirstChar);
            document.getElementById('btn-give-up')?.addEventListener('click', useGiveUp);
            document.getElementById('submit-score-btn')?.addEventListener('click', submitScore);
            const nameInp = document.getElementById('name-input');
            if (nameInp) { nameInp.addEventListener('keydown', e => { if (e.key === 'Enter') submitScore(); }); }
            document.getElementById('retry-btn')?.addEventListener('click', () => startGame(state.level));
            document.getElementById('menu-btn')?.addEventListener('click', () => { state.screen = 'start'; render(); });
        }

        function startGame(level) {
            state.level = level;
            state.currentQuestions = shuffle(questions[state.category][level]).slice(0, 10);
            state.questionIndex = 0; state.attempt = 1; state.score = 0; state.inputLocked = false; state.results = [];
            state.usedExtraHint = false; state.usedFirstChar = false; state.extraHintText = ''; state.firstCharText = '';
            state.leaderboard = []; state.leaderboardLoading = false; state.leaderboardFetched = false; state.scoreSubmitted = false; state.isSubmitting = false;
            state.screen = 'play'; render();
        }

        function submitAnswer() {
            if (state.inputLocked) return;
            const inp = document.getElementById('answer-input');
            const ans = inp.value.trim();
            if (!ans) { inp.classList.add('border-red-400'); setTimeout(() => inp.classList.remove('border-red-400'), 600); return; }
            const q = state.currentQuestions[state.questionIndex];
            if (ans === q.word) {
                const pts = state.attempt === 1 ? 10 : 5;
                state.score += pts; state.results.push({ word: q.word, correct: true, points: pts });
                showFeedback(true, () => nextQuestion());
            } else {
                if (state.attempt === 1) { state.attempt = 2; showFeedback(false, () => { state.inputLocked = false; render(); }); }
                else { state.results.push({ word: q.word, correct: false, points: 0 }); showFeedback(false, () => nextQuestion()); }
            }
        }

        function nextQuestion() {
            state.questionIndex++; state.attempt = 1; state.inputLocked = false;
            state.extraHintText = ''; state.firstCharText = '';
            state.screen = state.questionIndex >= state.currentQuestions.length ? 'result' : 'play';
            render();
            if (state.screen === 'result') { fetchLeaderboard(); }
        }

        function useExtraHint() {
            if (state.usedExtraHint || state.inputLocked) return;
            const q = state.currentQuestions[state.questionIndex];
            state.usedExtraHint = true;
            state.extraHintText = bonusHints[q.word] || 'é€™å’Œ' + categories[state.category].label.slice(2) + 'æœ‰é—œ';
            render();
        }

        function useFirstChar() {
            if (state.usedFirstChar || state.inputLocked) return;
            const q = state.currentQuestions[state.questionIndex];
            const firstChar = q.word[0];
            state.usedFirstChar = true;
            state.firstCharText = `ç­”æ¡ˆçš„ç¬¬ä¸€å€‹å­—æ˜¯ã€Œ${firstChar}ã€`;
            render();
        }

        function useGiveUp() {
            if (state.inputLocked) return;
            const q = state.currentQuestions[state.questionIndex];
            state.results.push({ word: q.word, correct: false, points: 0 });
            showFeedback(false, () => nextQuestion());
        }

        function showFeedback(correct, cb) {
            state.inputLocked = true;
            if (correct) { const s = document.getElementById('score-display'); if (s) s.classList.add('score-bounce'); }
            const ov = document.createElement('div');
            ov.className = 'feedback-overlay';
            ov.innerHTML = `< div class= "text-center" >
        <div class="text-[140px] sm:text-[180px] font-black leading-none select-none ${correct ? 'text-green-500' : 'text-red-500'}"
            style="text-shadow:0 0 60px ${correct ? 'rgba(34,197,94,.4)' : 'rgba(239,68,68,.4)'}">
            ${correct ? 'â­•' : 'âŒ'}</div>
        <div class="text-lg font-bold mt-2 ${correct ? 'text-green-600' : 'text-red-500'}">
            ${correct ? (state.attempt === 1 ? 'å¤ªæ£’äº†ï¼+10 åˆ†' : 'ç­”å°äº†ï¼+5 åˆ†') : 'ç­”éŒ¯äº†ï¼'}</div>
    </div > `;
            document.body.appendChild(ov);
            setTimeout(() => { ov.classList.add('fade-out'); setTimeout(() => { ov.remove(); cb(); }, 400); }, 1600);
        }

        async function fetchLeaderboardView() {
            state.viewLeaderboardLoading = true;
            render();
            try {
                const url = `${LEADERBOARD_API} ? category = ${state.category} & difficulty=${state.viewLeaderboardDiff}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) { state.viewLeaderboardData = data.leaderboard; }
            } catch (err) { console.error('æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—:', err); }
            state.viewLeaderboardLoading = false;
            render();
        }

        // ===== æ’è¡Œæ¦œ API å‡½å¼ =====
        async function fetchLeaderboard() {
            if (state.leaderboardFetched) return;
            state.leaderboardFetched = true;
            state.leaderboardLoading = true;
            render();
            try {
                const url = `${LEADERBOARD_API} ? category = ${state.category} & difficulty=${state.level}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) { state.leaderboard = data.leaderboard; }
            } catch (err) { console.error('æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—:', err); }
            state.leaderboardLoading = false;
            render();
        }

        async function submitScore() {
            if (state.isSubmitting || state.scoreSubmitted) return;
            const nameInp = document.getElementById('name-input');
            const btn = document.getElementById('submit-score-btn');
            if (!nameInp) return;
            const name = nameInp.value.trim();
            if (!name) { nameInp.classList.add('border-red-400'); setTimeout(() => nameInp.classList.remove('border-red-400'), 600); return; }
            if (name.length > 20) { alert('å§“åä¸å¯è¶…é20å€‹å­—å…ƒ'); return; }
            state.isSubmitting = true;
            // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é€å‡º
            if (btn) { btn.disabled = true; btn.textContent = 'é€å‡ºä¸­...'; }
            try {
                const res = await fetch(LEADERBOARD_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ category: state.category, difficulty: state.level, name, score: state.score })
                });
                const data = await res.json();
                if (data.success) {
                    state.scoreSubmitted = true;
                    state.leaderboard = data.leaderboard;
                    render();
                } else {
                    alert('é€å‡ºå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    if (btn) { btn.disabled = false; btn.textContent = 'é€å‡º'; }
                    state.isSubmitting = false;
                }
            } catch (err) {
                console.error('åˆ†æ•¸é€å‡ºå¤±æ•—:', err);
                alert('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                if (btn) { btn.disabled = false; btn.textContent = 'é€å‡º'; }
                state.isSubmitting = false;
            }
        }

        render();
    </script>
</body>

</html>